<?php

namespace Dictionary\DictionaryBundle\Repositories;

use Doctrine\ORM\EntityRepository;

/**
 * historyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HistoryRepository extends EntityRepository
{

	public function findByLatestSearched($user) {
		$histories = $this->createQueryBuilder('h')
			->select('h, word, piles.type as pile_type')
			->innerJoin('h.word', 'word')
			->leftJoin('DictionaryBundle:Piles', 'piles', 'WITH', 'piles.word = h.word AND piles.user = h.user')
			->where('h.anonymousId = :user')
			->setParameter('user', $user)
			->orderBy('h.lastSearch', 'DESC')
			->setMaxResults(20)
			->getQuery()
			->getResult();

		return $histories;
	}

	public function getSearchedByHits($user) {
		$historyByHits = $this->createQueryBuilder('h')
			->select('h, word, piles.type as pile_type')
			->innerJoin('h.word', 'word')
			->leftJoin('DictionaryBundle:Piles', 'piles', 'WITH', 'piles.word = h.word AND piles.user = h.user')
			->where('h.user = :user')
			->andWhere('h.hits >= :number')
			->setParameter('user', $user)
			->setParameter('number', 1)
			->addOrderBy('h.hits', 'DESC')
			->addOrderBy('h.updated', 'DESC')
			->setMaxResults(20)
			->getQuery()
			->getResult()
		;

		return $historyByHits;
	}
}
